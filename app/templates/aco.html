<!-- app/templates/aco.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Optimizaci√≥n de Rutas ACO</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
      <a class="btn-nav" href="/" title="Volver al inicio">üè†</a>
      <a class="btn-nav" href="/edit" title="Editar las rutas y cargar Excel"
        >‚úèÔ∏è</a
      >
      <a class="btn-nav" href="/genetic" title="Ejecutar algoritmo gen√©tico"
        >üß¨</a
      >
      <a class="btn-nav" href="/aco" title="Algoritmo de colonia de hormigas"
        >üêú</a
      >

      <button popovertarget="parametros-box" class="btn-nav">‚öôÔ∏è</button>
    </nav>

    <div popover id="parametros-box" class="popover-box">
      <button
        popovertarget="parametros-box"
        popovertargetaction="hide"
        class="close-pop"
      >
        ‚úñ
      </button>
      <h3>‚öôÔ∏è Par√°metros del algoritmo ACO</h3>

      <div class="param-row">
        <label for="alpha">Œ± (alpha)</label>
        <input
          id="alpha"
          type="number"
          step="0.1"
          value="1"
          class="param-input"
        />
        <p class="param-desc">
          Controla la <b>influencia de las feromonas</b> en la decisi√≥n del
          camino. Cuanto mayor sea Œ±, m√°s sigue las rutas marcadas por otros
          agentes.
        </p>
      </div>

      <div class="param-row">
        <label for="beta">Œ≤ (beta)</label>
        <input
          id="beta"
          type="number"
          step="0.1"
          value="2"
          class="param-input"
        />
        <p class="param-desc">
          Pondera la <b>importancia de la distancia o heur√≠stica</b>. Si Œ≤ es
          grande, el agente favorece caminos m√°s cortos.
        </p>
      </div>

      <div class="param-row">
        <label for="rho">œÅ (rho)</label>
        <input
          id="rho"
          type="number"
          step="0.1"
          value="0.5"
          class="param-input"
        />
        <p class="param-desc">
          Determina la <b>tasa de evaporaci√≥n</b> de las feromonas. Valores
          bajos = las feromonas duran m√°s tiempo.
        </p>
      </div>

      <div class="param-row">
        <label for="iterations">Iteraciones</label>
        <input id="iterations" type="number" value="5" class="param-input" />
        <p class="param-desc">
          N√∫mero de veces que se repite el proceso de b√∫squeda de rutas.
        </p>
      </div>

      <button
        id="save-params"
        popovertarget="parametros-box"
        popovertargetaction="hide"
        class="btn-save"
      >
        Guardar par√°metros
      </button>
    </div>

    <div class="main-container">
      <div class="left-panel">
        <div class="container-fluid">
          <span class="navbar-brand mb-0 h1">üêú ACO Route Optimizer</span>
        </div>
        <br />
        <!-- Veh√≠culos -->
        <div class="card p-3 mb-3">
          <h4>üöó Veh√≠culos</h4>
          <div id="vehicle-list"></div>
          <button class="btn btn-secondary mt-2" id="add-vehicle">
            Agregar veh√≠culo
          </button>
        </div>

        <div class="text-center mb-3">
          <button id="run-btn" class="btn btn-primary btn-lg">
            Ejecutar algoritmo
          </button>
        </div>
      </div>
      <div class="right-panel">
        <div id="result" class="text-center fw-bold"></div>
        <div id="routes" class="mt-4"></div>
        <div id="map" class="mt-4" style="height: 600px"></div>
        <ul id="missing-sites" style="color: rgb(184, 0, 0)"></ul>
      </div>
    </div>
    <script>
      let vehicleCount = 0;
      function addVehicleRow() {
        vehicleCount++;
        const div = document.createElement("div");
        div.className = "row g-3 mb-2 vehicle-row";
        div.innerHTML = `
    <div class="forms-col">
    <div class="col-md-3">
      <h5>Nombre del veh√≠culo:</h5>
      <input type="text" class="form-control veh-name" value="Car_${vehicleCount}" placeholder="Ej. Car_1">
    </div>

    <div class="col-md-3">
      <h5>Capacidad de carga (kg):</h5>
      <input type="number" class="form-control veh-capacity" value="1000" placeholder="Ej. 1000">
    </div>

    <div class="col-md-3">
      <h5>Experiencia (0 a 1):</h5>
      <input type="number" step="0.1" class="form-control veh-exp" value="0.8" placeholder="Ej. 0.8">
    </div>

    <div class="col-md-2 d-flex align-items-center">
      <button type="button" class="btn btn-delete">‚ùå</button>
    </div>
    </div>

  `;

        div.querySelector(".btn-delete").addEventListener("click", () => {
          div.remove();
        });

        document.getElementById("vehicle-list").appendChild(div);
      }

      $("#add-vehicle").click(addVehicleRow);
      addVehicleRow();

      $("#run-btn").click(async function () {
        $("#result").text("Ejecutando algoritmo...");
        $("#routes").empty();
        $("#map").empty();

        const vehicles = [];
        $(".veh-name").each(function (i) {
          vehicles.push({
            name: $(".veh-name").eq(i).val(),
            capacity: $(".veh-capacity").eq(i).val(),
            experience: $(".veh-exp").eq(i).val(),
          });
        });

        const payload = {
          alpha: $("#alpha").val(),
          beta: $("#beta").val(),
          rho: $("#rho").val(),
          iterations: $("#iterations").val(),
          vehicles: vehicles,
        };

        const res = await fetch("/run_aco", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();

        if (data.error) {
          $("#result").text("Error: " + data.error);
          return;
        }

        $("#result").html(
          `<b>Distancia total √≥ptima:</b> ${data.best_distance} km`
        );

        $("#map").html(data.map_html);

        let html = "<h5 class='mt-4'>üìã Orden de visita:</h5>";
        data.routes.forEach((r) => {
          html += `<div class="card mt-2 p-2"><b>${r.vehicle}</b><pre>${r.order}</pre></div>`;
        });
        $("#routes").html(html);

        let missingHtml =
          "<h5 class='mt-4 text-danger'>‚ö†Ô∏è Sitios no visitados:</h5>";
        if (data.missing_sites && data.missing_sites.length > 0) {
          missingHtml += "<ul class='list-group'>";
          data.missing_sites.forEach((site) => {
            missingHtml += `<li class='list-group-item list-group-item-warning'>${site}</li>`;
          });
          missingHtml += "</ul>";
        } else {
          missingHtml +=
            "<p class='text-success'>Todos los sitios fueron visitados ‚úÖ</p>";
        }
        $("#missing-sites").html(missingHtml);
      });
    </script>
  </body>

  <!-- Preloader -->
  <div id="preloader">
    <div class="loader">
      <div class="ant-icon">üêú</div>
      <p>CCargando ACO...</p>
    </div>
  </div>
  <script>
    window.addEventListener("load", () => {
      setTimeout(() => {
        document.getElementById("preloader").classList.add("fade-out");
        document.body.classList.add("loaded");
      }, 800);
    });
  </script>
</html>
